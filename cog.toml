# =============================================================================
# Cocogitto Configuration
# =============================================================================
#
# Cocogitto (cog) enforces Conventional Commits and automates versioning.
# Full documentation: https://docs.cocogitto.io/
#
# Quick reference:
#   cog check         - Verify all commits follow conventional format
#   cog bump --auto   - Bump version based on commit types (feat=minor, fix=patch)
#   cog bump --major  - Force a major version bump
#   cog changelog     - Generate/update CHANGELOG.md
#   cog install-hook  - Install git hooks defined in this file
#
# =============================================================================

# -----------------------------------------------------------------------------
# Commit Validation Settings
# -----------------------------------------------------------------------------

# Skip merge commits when validating commit messages.
# Merge commits are auto-generated by git and don't follow conventional format.
ignore_merge_commits = true

# Only allow version bumps from these branches.
# Prevents accidental releases from feature branches.
branch_whitelist = ["main"]

# -----------------------------------------------------------------------------
# Version Tag Settings
# -----------------------------------------------------------------------------

# Prefix for version tags (e.g., "v1.2.3" instead of "1.2.3").
# This is the most common convention and works well with GitHub releases.
tag_prefix = "v"

# Create a single global tag for the entire repository (e.g., v1.2.3).
# IMPORTANT: Must be true for  variable to work in global hooks.
# When false, cog uses a different code path that doesn't populate version vars.
generate_mono_repository_global_tag = true

# Don't create per-package tags (e.g., draftkit-v1.2.3).
# Since this workspace uses inherited versioning (all crates share one version),
# per-package tags would be redundant.
generate_mono_repository_package_tags = false
# -----------------------------------------------------------------------------
# Bump Hooks (Global Versioning)
# -----------------------------------------------------------------------------
#
# Hooks run during `cog bump`. Available variables:
#     - Current version before bump (e.g., "1.2.3")
#    - New version after bump (e.g., "1.3.0")
#
# Hook execution order:
#   1. pre_bump_hooks run
#   2. CHANGELOG.md is generated/updated
#   3. Version tag is created
#   4. post_bump_hooks run
#
# If any hook fails (non-zero exit), the bump is aborted.
# -----------------------------------------------------------------------------

pre_bump_hooks = [
  # Log the version transition for visibility
  "echo 'bumping from {{latest|0.0.0}} to {{version}}'",

  # Update version in all Cargo.toml files using cargo-edit.
  # This handles workspace-inherited versions automatically.
  # Install with: cargo install cargo-edit
  "cargo set-version {{version}}",

  # Verify the project compiles with the new version.
  # Uses --release to catch release-only issues (e.g., debug_assert differences).
  "cargo check --release",

  # Stage Cargo.lock for binary crates.
  # Binary projects should commit their lockfile to ensure reproducible builds.
  # Library projects typically .gitignore Cargo.lock.
  # The :/ prefix means "from repo root" regardless of current directory.
  "git add :/Cargo.lock"

]

post_bump_hooks = [
  # Push the version commit and tag to remote.
  # This triggers CI/CD workflows (e.g., cargo-dist for releases).
  "git push",
  "git push origin v{{version}}"

  # Create a draft GitHub release with changelog excerpt.
  # The awk command extracts the section for this version from CHANGELOG.md:
  #   - Starts capturing after "## []" heading
  #   - Stops capturing at the next "## [" heading
  # The release is created as draft so you can review before publishing.
  # Publishing the release triggers cargo-dist to build and attach binaries.
  '''
  awk '/^## \[\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md > /tmp/release-notes.md
  gh release create v --draft --title "v" -F /tmp/release-notes.md
  ''',
]
# -----------------------------------------------------------------------------
# Changelog Generation
# -----------------------------------------------------------------------------
#
# Cog generates changelogs from conventional commits.
# Templates determine the output format and what information is included.
#
# Built-in templates:
#   - simple           : Basic list of changes
#   - remote           : Includes links to commits/PRs on remote
#   - monorepo_remote  : Groups changes by package with remote links
#   - package_remote   : For individual package changelogs
#
# https://docs.cocogitto.io/guide/changelog.html
# -----------------------------------------------------------------------------

[changelog]
# Output file path relative to repository root
path = "CHANGELOG.md"

# Git remote hosting provider (for generating links)
# Supported: github.com, gitlab.com, bitbucket.org
remote = "github.com"

# Template for the main repository changelog.
# monorepo_remote groups commits by package and links to GitHub.
template = "monorepo_remote"

# Template for per-package changelogs (if using package-specific changelogs).
# Used when generate_mono_repository_package_tags = true.
package_template = "package_remote"

# Repository name on the remote (used for generating URLs)
repository = "draftkit"

# Repository owner/organization (used for generating URLs)
owner = "lovelesslabs"

# Map git commit signatures to usernames for changelog attribution.
# When a commit author matches a signature, their username is linked.
# Add entries for all regular contributors.
authors = [
  { signature = "clay@loveless.net", username = "claylo" },
  { signature = "Clay Loveless", username = "claylo" }
]

# -----------------------------------------------------------------------------
# Custom Commit Types
# -----------------------------------------------------------------------------
#
# Standard conventional commit types: feat, fix, docs, style, refactor, perf, test, build, ci, chore
#
# You can customize behavior or add new types here.
# Setting omit_from_changelog = true excludes commits from CHANGELOG.md
# but still allows them for validation and version calculation.
#
# https://docs.cocogitto.io/guide/commit.html
# -----------------------------------------------------------------------------

[commit_types]
# Maintenance tasks (deps, tooling) - don't clutter the changelog
chore = { omit_from_changelog = true }

# Test changes rarely interest end users
test = { omit_from_changelog = true }

# -----------------------------------------------------------------------------
# Git Hooks
# -----------------------------------------------------------------------------
#
# Cog can manage git hooks for your repository.
# Run `cog install-hook --all` to install hooks defined here.
#
# Hooks are shell scripts that run at specific git lifecycle points:
#   - commit-msg  : After commit message is entered, before commit is created
#   - pre-commit  : Before commit is created (after staging)
#   - pre-push    : Before push to remote
#
# Exit non-zero to abort the git operation.
#
# https://docs.cocogitto.io/guide/git_hooks.html
# -----------------------------------------------------------------------------

# Validate and clean commit messages before finalizing the commit.
[git_hooks.commit-msg]
script = '''#!/bin/sh
set -e

# Remove Claude Code attribution lines if present.
# This gives the committer control over when/how to credit AI assistance.
# Removes lines containing "Generated with [Claude Code]" or "Co-Authored-By: Claude"
perl -i -ne 'print unless /Generated with \[Claude Code\]|^Co-Authored-By:\s*Claude/i' "$1"

# Clean up whitespace in the commit message:
#   1. Trim trailing whitespace from each line
#   2. Collapse 3+ consecutive newlines to 2 (keep paragraph breaks, remove excess)
#   3. Ensure file ends with exactly one newline
perl -i -0777 -pe '
  s/[ \t]+$//mg;     # trim trailing whitespace per line
  s/\n{3,}/\n\n/g;   # collapse 3+ newlines to 2
  s/\n*\z/\n/;       # ensure exactly one final newline
' "$1"

# Verify the commit message follows conventional commit format.
# Fails if message doesn't match: type(scope): description
cog verify --file "$1"
'''

# Run checks before allowing a commit.
[git_hooks.pre-commit]
script = """#!/bin/sh
set -e

# Verify code is formatted. Use --check to fail without modifying files.
# Run `cargo fmt` to fix formatting issues.
cargo fmt --all --check

# Run clippy with warnings as errors.
# Ensures committed code passes lint checks.
cargo clippy -- -D warnings

# Check for updates without blocking the commit
just check-updates
"""

# Run tests before allowing a push.
[git_hooks.pre-push]
script = """#!/bin/sh
set -e

# Run the test suite. Prevents pushing broken code.
# Consider using `cargo nextest run` for faster parallel tests.
cargo test
"""

# -----------------------------------------------------------------------------
# Monorepo Package Definitions
# -----------------------------------------------------------------------------
#
# Define packages in the workspace for monorepo versioning.
# Each package can have its own version, hooks, and changelog.
#
# With generate_mono_repository_global_tag = true, all packages share
# the global version. Individual package paths are still needed so cog
# knows which directories contain crates.
#
# https://docs.cocogitto.io/guide/monorepo.html
# -----------------------------------------------------------------------------

[packages]
# The main CLI binary
draftkit = { path = "crates/draftkit" }

# The core library (config, errors, shared functionality)
draftkit-core = { path = "crates/draftkit-core" }
